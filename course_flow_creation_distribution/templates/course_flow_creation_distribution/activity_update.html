{% load static i18n %} {% get_current_language as LANGUAGE_CODE %}

<!DOCTYPE html>
<html lang="{{LANGUAGE_CODE}}">
  <head>
    <title>{% block title %}{% endblock %}</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="{% block metadescription %}{% endblock %}"
    />
    <meta name="theme-color" content="#1976BC" />

    <!-- External resources -->
    <!-- * Fonts and icons -->
    <link
      href="https://fonts.googleapis.com/css?family=Material+Icons|Roboto|Fanwood+Text:400i|Quicksand:300,400|Rubik:200,300,300i,400"
      rel="stylesheet"
      type="text/css"
    />

    <!-- * Scripts -->
    <!-- ** Preloads -->
    <link
      rel="preload"
      href="https://cdn.polyfill.io/v2/polyfill.min.js"
      as="script"
    />
    <link rel="preload" href="https://d3js.org/d3.v5.min.js" as="script" />
    <!-- ** jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- ** Polyfills for non-awesome browsers-->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
    <!-- ** d3 -->
    <script
      src="https://d3js.org/d3.v5.min.js"
      defer="true"
      charset="utf-8"
    ></script>
    <!-- ** material design components -->
    <link
      href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css"
      rel="stylesheet"
    />
    <link
      href="https://www.unpkg.com/preact-material-components@1.6.1/Dialog/style.css"
      rel="stylesheet"
    />
    <link
      href="https://www.unpkg.com/preact-material-components@1.6.1/Button/style.css"
      rel="stylesheet"
    />

    <!-- Internal resources -->
    <!-- * CSS -->
    <link
      rel="stylesheet"
      href="{% static 'course_flow_creation_distribution/css/base_style.css' %}"
    />
  </head>

  <body id="site">
    <div class="topnav">
      <div class="titlebar">
        <div class="title">
          <font size="6"><b>CourseFlow</b></font>
        </div>
      </div>
      <div class="menubar">
        <div class="topnavimage">
          <a href="www.saltise.ca"
            ><img
              src="{% static 'course_flow_creation_distribution/img/saltise_logo.svg'%}"
              href="www.saltise.ca"
          /></a>
        </div>
        <div class="topdropwrapper">
          <button class="topdropbutton">File</button>
          <div class="topdropdiv">
            <a id="new">New Project</a>
            <a id="save"
              ><div>Save Project</div>
              <div class="shortcut">Ctrl+S</div></a
            >
            <a id="open"
              ><div>Open Project</div>
              <div class="shortcut">Ctrl+O</div></a
            >
            <a id="export">Export Current Workflow</a>
            <a id="import">Import a Workflow</a>
          </div>
        </div>
        <div class="topdropwrapper">
          <button class="topdropbutton">Edit</button>
          <div class="topdropdiv">
            <a id="undo"
              ><div>Undo</div>
              <div class="shortcut">Ctrl+Z</div></a
            >
            <a id="redo"
              ><div>Redo</div>
              <div class="shortcut">Ctrl+Shift+Z</div></a
            >
            <a id="duplicatewf"><div>Duplicate Current Workflow</div></a>
          </div>
        </div>
        <div class="topdropwrapper">
          <button class="topdropbutton">View</button>
          <div class="topdropdiv">
            <a id="expand">Expand All Nodes</a>
            <a id="collapse">Collapse All Nodes</a>
            <a id="print">Printer Friendly Version</a>
          </div>
        </div>
        <div class="topdropwrapper">
          <button class="topdropbutton">Help</button>
          <div class="topdropdiv">
            <a id="genhelp">General Help</a>
            <a id="layouthelp">About the Layout</a>
          </div>
        </div>
      </div>
    </div>
    <div class="form-popup" id="strategy-form">
      <form class="form-container">
        <h1>Create a Node</h1>
        <form method="post">
          {% csrf_token %} {{ node_form.as_ul }}
          <input type="submit" value="Submit" />
        </form>
      </form>
    </div>
    <div class="form-popup" id="strategy-form">
      <form class="form-container">
        <h1>Create a Strategy</h1>
        <form method="post">
          {% csrf_token %} {{ strategy_form.as_ul }}
          <input type="submit" value="Submit" />
        </form>
      </form>
    </div>
    <div id="app"></div>
    <svg width="2000" height="10000">
      <defs>
        <filter id="selection-shadow">
          <feDropShadow dx="1" dy="1" stdDeviation="2" />
        </filter>
      </defs>
    </svg>
    <div class="mdc-snackbar">
      <div class="mdc-snackbar__surface">
        <div class="mdc-snackbar__label" role="status" aria-live="polite">
          Can't send photo. Retry in 5 seconds.
        </div>
        <div class="mdc-snackbar__actions">
          <button type="button" class="mdc-button mdc-snackbar__action">
            Retry
          </button>
        </div>
      </div>
    </div>

    <footer></footer>
  </body>
  {% csrf_token %}

  <script>



            window.addEventListener("load", function() {

            function openForm() {
              document.getElementById("myForm").style.display = "block";
            }

            function closeForm() {
              document.getElementById("myForm").style.display = "none";
            }
    /*
            function updateActivityInfo(activity){
              widget.node().__data__.title =
              widget.node().__data__.description =

              updateJson();
            }
            function updateStrategyInfo(strategy){
              widget.node().__data__.strategy.title =
              widget.node().__data__.strategy.description =
              updateJson();
            }
            function updateNodeInfo(node){
              widget.node().__data__.node.title =
              widget.node().__data__.node.description =
              widget.node().__data__.node.classification =
              widget.node().__data__.node.activity_classification =
              widget.node().__data__.node.work_classification =
              updateJson();
            }
            */
              const svgParent = d3.select("svg").style("margin-top", "100px");

              let activityJson = {{ activity_json|safe }};

              const popularNodeJson = {{ popoular_node_json|safe }};

              const defaultStrategyJson = {{ default_strategy_json|safe }};

              const totalHeight = 900;

              const sideBoardWidth = 450;

              console.log(activityJson, popularNodeJson, defaultStrategyJson);



              function renderNodeBoard(parent, jsonData){

              const boardNodes = parent.selectAll('.board-node').data(jsonData).enter()
                                .append("svg").attr("class",'board-node')
                                .attr("x", `${nodeTotalSpacingHorizontal*3+50}`)
                                .attr("y", (d,i) => `${nodeTotalSpacingVertical*i+50}`)
                                .attr("width", `${nodeWidth}`).attr("height", `${nodeHeight}`);

              boardNodes.append("rect").attr('x', 0).attr('y', 0).attr("rx", "6")
                  .attr("width", `${nodeWidth}`).attr("height", `${nodeHeight}`)
                  .attr("fill", "#979797").style('pointer-events', 'none');

                  boardNodes
                    .append('text')
                    .style('font-family', 'Roboto')
                    .attr('class', 'node-title')
                    .attr('x', "15")
                    .attr('y', "20")
                    .attr('dy', 6)
                    .style('font-size', 18)
                    .style('fill', "white")
                    .style('pointer-events', 'none')
                    .text(d => d.title);

                    boardNodes
                      .append('text')
                      .style('font-family', 'Roboto')
                      .attr('class', 'node-author')
                      .attr('x', "15")
                      .attr('y', "40")
                      .attr('dy', 6)
                      .style('font-size', 12)
                      .style('fill', "white")
                      .style('pointer-events', 'none')
                      .text(d=> "created by "+d.author);

                      boardNodes
                        .append('text')
                        .style('font-family', 'Roboto')
                        .attr('class', 'node-description')
                        .attr('x', "15")
                        .attr('y', "70")
                        .attr('dy', 6)
                        .style('font-size', 14)
                        .style('fill', "white")
                        .style('pointer-events', 'none')
                        .text(d => d.description);

                      boardNodes.append("g")
                        .attr("class", "action-icon")
                        .append('image')
                        .attr('x', `${nodeWidth-40}`)
                        .attr('y', `${nodeHeight-45}`)
                        .attr("width", `${31}`)
                        .attr("height", `${31}`)
                        .attr("xlink:href","{% static 'course_flow_creation_distribution/img/rubbish-bin-delete-button.svg' %}");

                      boardNodes.append("g")
                        .attr("class", "action-icon")
                        .append('image')
                        .attr('x', `${nodeWidth-40}`)
                        .attr('y', `${nodeHeight-90}`)
                        .attr("width", `${31}`)
                        .attr("height", `${31}`)
                        .attr("xlink:href","{% static 'course_flow_creation_distribution/img/pencil.svg' %}");


                      boardNodes
                        .append('image')
                        .style('pointer-events', 'none')
                        .attr('x', `${nodeWidth-135}`)
                        .attr('y', `${10}`)
                        .attr("width", `${31}`)
                        .attr("height", `${31}`)
                        .attr("xlink:href","{% static 'course_flow_creation_distribution/img/multiple-users-silhouette.svg' %}");

                      boardNodes
                        .append('image')
                        .style('pointer-events', 'none')
                        .attr('x', `${nodeWidth-95}`)
                        .attr('y', `${10}`)
                        .attr("width", `${31}`)
                        .attr("height", `${31}`)
                        .attr("xlink:href","{% static 'course_flow_creation_distribution/img/classroom.svg' %}");

                      const dragDropIcons = boardNodes.append("g")
                        .attr("class", "drag-icon")
                        .append('image')
                        .attr('x', `${nodeWidth-30}`)
                        .attr('y', `${10}`)
                        .attr("width", `${20}`)
                        .attr("height", `${20}`)
                        .attr("xlink:href","{% static 'course_flow_creation_distribution/img/reorder-option (1).svg' %}");


                function makeDragDropBoardNode() {
                  let widget = undefined;
                  let color = undefined;
                  let initX = undefined;
                  let initY = undefined;

                  let drags = d3
                    .drag()
                    .on("start", function() {
                      widget = d3.select(this);
                      dragDropIcons.style("cursor","grabbing");
                      initX = +widget.attr("x");
                      initY = +widget.attr("y");
                      color = widget.select("rect").attr("fill");
                      strategies = d3.selectAll(".strategy");
                      widget.select("rect").attr("filter","url(#selection-shadow)")
                            .attr('x', 5).attr('y', 4)
                            .attr("width", `${nodeWidth-10}`).attr("height", `${nodeHeight-8}`);
                      swapDiv(this);
                    })
                    .on("drag", function() {
                      widget.attr("x", d3.event.x-nodeWidth+20).attr("y", d3.event.y-20);

                      let flag = true;

                      strategies.each(function(i,j){
                          strategy = d3.select(this);
                          if(flag&&(+strategy.attr("y")+(+strategy.attr("height")))>(+widget.attr("y")+(+widget.attr("height")))
                              &&(+strategy.attr("x")+(+strategy.attr("width")))>(+widget.attr("x")+(+widget.attr("width")))
                              &&+strategy.attr("y")<+widget.attr("y")&&+strategy.attr("x")<+widget.attr("x")){

                              widget.select("rect").attr("fill", "#1976BC");
                              flag = false;
                          }
                      });

                      if(flag) widget.select("rect").attr("fill", color);


                    })
                    .on("end", function() {

                      strategies.each(function(i,j){
                          strategy = d3.select(this);
                          if(+strategy.attr("y")+(+strategy.attr("height"))>(+widget.attr("y")+(+widget.attr("height")))
                              &&(+strategy.attr("x")+(+strategy.attr("width")))>(+widget.attr("x")+(+widget.attr("width")))
                              &&+strategy.attr("y")<+widget.attr("y")&&+strategy.attr("x")<+widget.attr("x")){

                                addNode(widget.node().__data__.id, strategy.node().__data__.strategy.id);

                          }
                      });

                      dragDropIcons.style("cursor","grab");
                      widget.select("rect").attr("fill", color).attr("y", 0).attr("x",0)
                      .attr("width", `${nodeWidth}`).attr("height", `${nodeHeight}`).attr("filter", "");
                      widget.attr("x", initX).attr("y", initY).style("cursor","default");

                      widget = undefined;
                    });

                  drags(boardNodes);
                }
                makeDragDropBoardNode();

            }


            let repositionBoard = function(){
              let displacement = $(window).scrollTop();
              d3.selectAll('.board-node').attr("y", (d,i) => `${nodeTotalSpacingVertical*i+50+displacement}`);
              d3.selectAll('.default-strategy').attr("y", (d,i) => `${nodeTotalSpacingVertical*i+totalHeight/2+displacement}`);
            }





      function renderStrategyBoard(parent, jsonData){

              const defaultStrategies = parent.selectAll('.default-strategy').data(jsonData).enter()
                                .append("svg").attr("class","default-strategy")
                                .attr("x", `${nodeTotalSpacingHorizontal*3+50}`)
                                .attr("y", (d,i) => `${nodeTotalSpacingVertical*i+totalHeight/2}`);

              defaultStrategies.append("rect").attr('x', 0).attr('y', 0).attr("rx", "6")
                  .attr("width", `${nodeWidth}`).attr("height", `${nodeHeight}`)
                  .attr("fill", (d,i) => scC(i)).attr("stroke", "black");

              defaultStrategies
                .append('text')
                .style('font-family', 'Quicksand, sans-serif')
                .attr('class', 'node-label')
                .attr('x', `${nodeMidpointHorizontal}`)
                .attr('y', `${nodeMidpointVertical}`)
                .attr('dy', 6)
                .style('font-size', 14)
                .attr('text-anchor', 'middle')
                .style('fill', 'black')
                .style('pointer-events', 'none')
                .text(d => d.node.title);

                function makeDragDropBoardStrategy() {
                  let widget = undefined;
                  let color = undefined;
                  let initX = undefined;
                  let initY = undefined;

                  let drags = d3
                    .drag()
                    .on("start", function() {
                      widget = d3.select(this).style("cursor","move");
                      initX = +widget.attr("x");
                      initY = +widget.attr("y");
                      color = widget.select("rect").attr("fill");
                      activity = d3.select(".activity");
                      widget.select("rect").attr("filter","url(#selection-shadow)")
                            .attr('x', 5).attr('y', 4)
                            .attr("width", `${nodeWidth-10}`).attr("height", `${nodeHeight-8}`);
                      swapDiv(this);
                    })
                    .on("drag", function() {
                      widget.attr("x", d3.event.x-nodeMidpointHorizontal).attr("y", d3.event.y-nodeMidpointVertical);


                          if((+activity.attr("y")+runningActivityHeight)>(+widget.attr("y")+(+widget.attr("height")))
                              &&(+activity.attr("x")+(+activity.attr("width")))>(+widget.attr("x")+(+widget.attr("width")))
                              &&+activity.attr("y")<+widget.attr("y")&&+activity.attr("x")<+widget.attr("x")){

                              widget.select("rect").attr("fill", "red");
                              flag = false;
                          }else{
                              widget.select("rect").attr("fill", color);
                            }

                    })
                    .on("end", function() {

                          if((+activity.attr("y")+runningActivityHeight)>(+widget.attr("y")+(+widget.attr("height")))
                              &&(+activity.attr("x")+(+activity.attr("width")))>(+widget.attr("x")+(+widget.attr("width")))
                              &&+activity.attr("y")<+widget.attr("y")&&+activity.attr("x")<+widget.attr("x")){

                                addStrategy(widget.node().__data__.id);

                          }


                      widget.select("rect").attr("fill", color).attr("y", 0).attr("x",0)
                        .attr("width", `${nodeWidth}`).attr("height", `${nodeHeight}`).attr("filter", "");
                      widget.attr("x", initX).attr("y", initY).style("cursor","default");

                      widget = undefined;
                    });

                  drags(defaultStrategies);
                }
                makeDragDropBoardStrategy();


              }


              const nodeHeight = 160.0;
              const nodeWidth = 450.0;
              const nodeSpacingVertical = 50.0;
              const nodeSpacingHorizontal = 30.0;
              const nodeTotalSpacingVertical = nodeHeight + nodeSpacingVertical;
              const nodeTotalSpacingHorizontal = nodeWidth + nodeSpacingHorizontal;

              const nodeMidpointVertical = nodeHeight/2.0;
              const nodeMidpointHorizontal = nodeWidth/2.0;

              const strategyPadding = 30.0;
              const strategyInfoHeight = 200.0;
              const strategyVerticalSpacing = 20.0;

              const activityInfoHeight = 200.0;

              const strategyWidth = 2*strategyPadding+nodeTotalSpacingHorizontal*3-nodeSpacingHorizontal;

              const scC = d3.scaleOrdinal( d3.schemePastel1 );

              function swapDiv(referenceNode){
                  referenceNode.parentNode.insertBefore(referenceNode, referenceNode.parentNode.lastChild.nextSibling);
              }

              renderActivity(activityJson.strategyactivity_set, svgParent);

              renderNodeBoard(svgParent, popularNodeJson);
              renderStrategyBoard(svgParent, defaultStrategyJson);

              window.addEventListener("scroll", repositionBoard);

              function renderActivity(strategyActivitySet, parent){

                  d3.selectAll(".activity").remove();

                  const svgActivity = parent
                                      .append("svg").attr("x","0").attr("y","0")
                                      .attr("width", `${strategyWidth}`)
                                      .attr("class","activity");

                  svgActivity
                    .append('text')
                    .style('font-family', 'Roboto')
                    .attr('class', 'node-title')
                    .attr('x', "15")
                    .attr('y', "20")
                    .attr('dy', 6)
                    .style('font-size', 18)
                    .style('fill', "white")
                    .style('pointer-events', 'none')
                    .text(activityJson.title);

                  svgActivity
                    .append('text')
                    .style('font-family', 'Roboto')
                    .attr('class', 'node-author')
                    .attr('x', "15")
                    .attr('y', "40")
                    .attr('dy', 6)
                    .style('font-size', 12)
                    .style('fill', 'white')
                    .style('pointer-events', 'none')
                    .text("created by "+activityJson.author);

                  svgActivity
                    .append('text')
                    .style('font-family', 'Roboto')
                    .attr('class', 'node-description')
                    .attr('x', "15")
                    .attr('y', "70")
                    .attr('dy', 6)
                    .style('font-size', 14)
                    .style('fill', "white")
                    .style('pointer-events', 'none')
                    .text(activityJson.description);

                  svgActivity.append("g")
                    .attr("class", "action-icon")
                    .append('image')
                    .attr('x', `${strategyWidth-40}`)
                    .attr('y', `${60}`)
                    .attr("width", `${31}`)
                    .attr("height", `${31}`)
                    .attr("xlink:href","{% static 'course_flow_creation_distribution/img/rubbish-bin-delete-button.svg' %}");

                  svgActivity.append("g")
                    .attr("class", "action-icon")
                    .on("click", function(d,i){
                        //openUpdateForm(d3.select(this.parentNode));
                        console.log(d3.select(this.parentNode).data());
                    })
                    .append('image')
                    .attr('x', `${strategyWidth-40}`)
                    .attr('y', `${15}`)
                    .attr("width", `${31}`)
                    .attr("height", `${31}`)
                    .attr("xlink:href","{% static 'course_flow_creation_distribution/img/pencil.svg' %}");


                  var runningActivityHeight = activityInfoHeight;

                  svgActivity.selectAll('.strategy').remove();


                  const strategies = svgActivity.selectAll('.strategy').data(strategyActivitySet).enter()
                                    .append("svg").attr("class","strategy")
                                    .attr("x", "0")
                                    .attr("height", (d,i)=>`${d.strategy.nodestrategy_set.length*(nodeHeight+nodeSpacingVertical)-nodeSpacingVertical+2*strategyPadding+strategyInfoHeight}`)
                                    .attr("width", `${strategyWidth}`)
                                    .each(function(d,i){

                                        d3.select(this).append("rect").attr('x', 0).attr('y', 0).attr("rx", "6").style('pointer-events', 'none')
                                            .attr("width", `${(nodeWidth+nodeSpacingHorizontal)*3-nodeSpacingHorizontal}`)
                                            .attr("height", `${d.strategy.nodestrategy_set.length*(nodeHeight+nodeSpacingVertical)-nodeSpacingVertical+2*strategyPadding+strategyInfoHeight}`)
                                            .attr("width", `${strategyWidth}`)
                                            .attr("fill", "#EDAA1E");
                                        renderStrategy(d.strategy.nodestrategy_set, d3.select(this));
                                    });

                      for(let i = 0; i<strategyActivitySet.length; i++){
                        for(let j = 0; j<strategyActivitySet.length; j++){
                          if(strategies["_groups"][0][j].__data__.rank == i){
                              d3.select(strategies["_groups"][0][j]).attr("y", `${runningActivityHeight}`);
                              runningActivityHeight += +d3.select(strategies["_groups"][0][j]).attr("height")+strategyVerticalSpacing;
                          }
                        }
                      }

                        strategies
                          .append('text')
                          .style('font-family', 'Roboto')
                          .attr('class', 'node-title')
                          .attr('x', "15")
                          .attr('y', "20")
                          .attr('dy', 6)
                          .style('font-size', 18)
                          .style('fill', "#1976BC")
                          .style('pointer-events', 'none')
                          .text(d => d.strategy.title);

                        strategies
                          .append('text')
                          .style('font-family', 'Roboto')
                          .attr('class', 'node-author')
                          .attr('x', "15")
                          .attr('y', "40")
                          .attr('dy', 6)
                          .style('font-size', 12)
                          .style('fill', '#1976BC')
                          .style('pointer-events', 'none')
                          .text(d=> "created by "+d.strategy.author);

                        strategies
                          .append('text')
                          .style('font-family', 'Roboto')
                          .attr('class', 'node-description')
                          .attr('x', "15")
                          .attr('y', "70")
                          .attr('dy', 6)
                          .style('font-size', 14)
                          .style('fill', "#1976BC")
                          .style('pointer-events', 'none')
                          .text(d => d.strategy.description);

                      strategies.append("g")
                        .attr("class", "action-icon")
                        .append('image')
                        .attr('x', `${strategyWidth-40}`)
                        .attr('y', `${90}`)
                        .attr("width", `${31}`)
                        .attr("height", `${31}`)
                        .attr("xlink:href","{% static 'course_flow_creation_distribution/img/rubbish-bin-delete-button-blue.svg' %}");

                      strategies.append("g")
                        .attr("class", "action-icon")
                        .on("mousedown", function(d,i){
                            //openUpdateForm(d3.select(this.parentNode));
                            console.log(d3.select(this.parentNode).node().__data__);
                        })
                        .append('image')
                        .attr('x', `${strategyWidth-40}`)
                        .attr('y', `${45}`)
                        .attr("width", `${31}`)
                        .attr("height", `${31}`)
                        .attr("xlink:href","{% static 'course_flow_creation_distribution/img/pencil-blue.svg' %}");

                    const dragDropIcons =  strategies.append("g")
                        .attr("class", "drag-icon")
                        .append('image')
                        .attr('x', `${strategyWidth-30}`)
                        .attr('y', `${10}`)
                        .attr("width", `${20}`)
                        .attr("height", `${20}`)
                        .attr("xlink:href", "{% static 'course_flow_creation_distribution/img/reorder-option-blue.svg' %}");



                  function makeDragDropStrategy() {
                    let widget = undefined;
                    let color = undefined;
                    let widgetData = undefined;
                    let initYAxis = undefined;

                    let drags = d3
                      .drag()
                      .on("start", function() {
                        widget = d3.select(this);
                        d3.selectAll(".strategy").attr("height", strategyInfoHeight).attr("y",(d,i)=>d.rank*(strategyInfoHeight+strategyVerticalSpacing)+activityInfoHeight).select("rect").attr("height", strategyInfoHeight);
                        widget.select("rect").attr("filter","url(#selection-shadow)")
                              .attr('x', 5).attr('y', 4)
                              .attr("width", +widget.attr("width")-10).attr("height", +widget.attr("height")-8);
                        widgetData = widget.node().__data__;
                        initYAxis = widget.attr("y");
                        swapDiv(this);
                        dragDropIcons.style("cursor","grabbing");
                      })
                      .on("drag", function() {
                        widget.attr("y", `${d3.event.y-15}`);
                        d3.event.x = strategyWidth-15;
                        if(d3.event.y<initYAxis){
                            strategies.each(function(d,i) { if((d.rank == widgetData.rank-1)&&((+d3.select(this).attr("y")+(+d3.select(this).attr("height"))/2)>=+widget.attr("y"))){
                              [d.rank, widgetData.rank] = [widgetData.rank, d.rank];
                              d3.select(this).attr("y",`${+d3.select(this).attr("y")+(+widget.attr("height"))}`);
                            }});
                        }
                        else{
                          strategies.each(function(d,i) { if((d.rank == widgetData.rank+1)&&((+d3.select(this).attr("y")+(+d3.select(this).attr("height"))/2)<=(+widget.attr("y")+(+widget.attr("height"))))){
                            [d.rank, widgetData.rank] = [widgetData.rank, d.rank];
                            d3.select(this).attr("y",`${+d3.select(this).attr("y")-(+widget.attr("height"))}`);
                          }});
                        }
                        initYAxis = d3.event.y;
                      })
                      .on("end", function() {
                        let yRealignPos = 0;
                        strategies.each(function(d,i) {
                            if(d3.select(this).node().__data__.rank<widgetData.rank){
                               yRealignPos += +d3.select(this).attr("height");
                            }
                        });
                        widget.attr("y", `${yRealignPos}`);
                        widget.select("rect").attr("filter","")
                              .attr('x', 0).attr('y', 0)
                              .attr("width", +widget.attr("width")).attr("height", +widget.attr("height"));
                        dragDropIcons.style("cursor","grab");
                        updateJson();
                        console.log(strategyActivitySet);
                        renderActivity(strategyActivitySet, svgParent);
                        widget = undefined;
                      });

                    drags(strategies);
                  }

                  makeDragDropStrategy();

              }


              function pathToNextSiblingRect(s, i) {
                path = "M" + (s[i].x.animVal.value+nodeMidpointHorizontal) + "," + (s[i].y.animVal.value+nodeHeight) + "C" + (s[i].x.animVal.value+nodeMidpointHorizontal) + ","
                        + (s[i].y.animVal.value + nodeHeight + s[i+1].y.animVal.value) / 2 + " " + (s[i+1].x.animVal.value+nodeMidpointHorizontal) + "," +  (s[i].y.animVal.value + nodeHeight + s[i+1].y.animVal.value) / 2
                        + " " + (s[i+1].x.animVal.value+nodeMidpointHorizontal) + "," + s[i+1].y.animVal.value;
                return path
              }





              function renderNodeLinks(svg){

                  svg.selectAll('path').remove();

                  let rects = svg.selectAll('.node')['_groups'][0];

                  sortedRects = [rects.length];

                  for(let i=0; i<rects.length; i++){
                      for(let j=0; j<rects.length; j++){
                      if(i==rects[j].__data__.rank){
                          sortedRects[i]=rects[j];
                      }
                      else if(rects[j].__data__.rank<0) sortedRects[0]=rects[j];
                      else if(rects[j].__data__.rank>rects.length-1) sortedRects[rects.length-1]=rects[j];
                    }
                  }

                  for(let i=0; i<rects.length-1; i++){
                      svg.append("path")
                          .style("stroke", "black")
                          .style("stroke-width", 3)
                          .attr('fill', 'none')
                          .attr("d",  pathToNextSiblingRect(sortedRects, i));


                  }


              }


              function renderStrategy(nodeStrategySet, svg){


                const nodes = svg.selectAll('.node').data(nodeStrategySet).enter()
                                  .append("svg").attr("class","node")
                                  .attr("x", (d,i) => `${nodeTotalSpacingHorizontal*d.node.classification+strategyPadding}`)
                                  .attr("y", (d,i) => `${nodeTotalSpacingVertical*d.rank+strategyPadding+strategyInfoHeight}`);

                nodes.append("rect").attr('x', 0).attr('y', 0).attr("rx", "6").attr("class","node-rect")
                    .attr("fill","#1976BC").attr("width", `${nodeWidth}`).attr("height", `${nodeHeight}`).style('pointer-events', 'none');

                nodes
                  .append('text')
                  .style('font-family', 'Roboto')
                  .attr('class', 'node-title')
                  .attr('x', "15")
                  .attr('y', "20")
                  .attr('dy', 6)
                  .style('font-size', 18)
                  .style('fill', "white")
                  .style('pointer-events', 'none')
                  .text(d => d.node.title);

                  nodes
                    .append('text')
                    .style('font-family', 'Roboto')
                    .attr('class', 'node-author')
                    .attr('x', "15")
                    .attr('y', "40")
                    .attr('dy', 6)
                    .style('font-size', 12)
                    .style('fill', 'white')
                    .style('pointer-events', 'none')
                    .text(d=> "created by "+d.node.author);

                    nodes
                      .append('text')
                      .style('font-family', 'Roboto')
                      .attr('class', 'node-description')
                      .attr('x', "15")
                      .attr('y', "70")
                      .attr('dy', 6)
                      .style('font-size', 14)
                      .style('fill', "white")
                      .style('pointer-events', 'none')
                      .text(d => d.node.description);

                    nodes.append("g")
                      .attr("class", "action-icon")
                      .append('image')
                      .attr('x', `${nodeWidth-40}`)
                      .attr('y', `${nodeHeight-45}`)
                      .attr("width", `${31}`)
                      .attr("height", `${31}`)
                      .attr("xlink:href","{% static 'course_flow_creation_distribution/img/rubbish-bin-delete-button.svg' %}");

                    nodes.append("g")
                      .attr("class", "action-icon")
                      .on("mousedown", function(d,i){
                        console.log(d3.select(this.parentNode).node().__data__);
                      })
                      .append('image')
                      .attr('x', `${nodeWidth-40}`)
                      .attr('y', `${nodeHeight-90}`)
                      .attr("width", `${31}`)
                      .attr("height", `${31}`)
                      .attr("xlink:href","{% static 'course_flow_creation_distribution/img/pencil.svg' %}");


                    nodes
                      .append('image')
                      .style('pointer-events', 'none')
                      .attr('x', `${nodeWidth-135}`)
                      .attr('y', `${10}`)
                      .attr("width", `${31}`)
                      .attr("height", `${31}`)
                      .attr("xlink:href","{% static 'course_flow_creation_distribution/img/multiple-users-silhouette.svg' %}");

                    nodes
                      .append('image')
                      .style('pointer-events', 'none')
                      .attr('x', `${nodeWidth-95}`)
                      .attr('y', `${10}`)
                      .attr("width", `${31}`)
                      .attr("height", `${31}`)
                      .attr("xlink:href","{% static 'course_flow_creation_distribution/img/classroom.svg' %}");

                    const dragDropIcons = nodes.append("g")
                      .attr("class", "drag-icon")
                      .append('image')
                      .attr('x', `${nodeWidth-30}`)
                      .attr('y', `${10}`)
                      .attr("width", `${20}`)
                      .attr("height", `${20}`)
                      .attr("xlink:href","{% static 'course_flow_creation_distribution/img/reorder-option (1).svg' %}");





                renderNodeLinks(svg);

                  function reorderByRank(previousRank, newRank){
                      nodes.each(function(d,i) { if(d.rank == newRank){
                        d.rank=previousRank;
                        d3.select(this).attr("y",`${d.rank*nodeTotalSpacingVertical+strategyPadding+strategyInfoHeight}`);
                      }});
                  }

              function makeDragDropNode() {
                let widget = undefined;
                let color = undefined;
                let initRank = undefined;
                let currentRank = undefined;
                let initClassification = undefined;
                let currentClassification = undefined;
                let widgetData = undefined;

                let drags = d3
                  .drag()
                  .on("start", function() {
                    widget = d3.select(this);
                    color = widget.select("rect").attr("fill");
                    widget.select("rect").attr("filter","url(#selection-shadow)")
                          .attr('x', 5).attr('y', 4)
                          .attr("width", `${nodeWidth-10}`).attr("height", `${nodeHeight-8}`);
                    dragDropIcons.style("cursor","grabbing");
                    widgetData = widget.node().__data__;
                    initRank = widgetData.rank;
                    initClassification = widgetData.node.classification
                    swapDiv(this);
                  })
                  .on("drag", function() {
                    widget.attr("x", d3.event.x-nodeWidth+20).attr("y", d3.event.y-20);
                    currentRank = Math.round((widget.attr("y")-strategyPadding-strategyInfoHeight)/nodeTotalSpacingVertical);
                    currentClassification = Math.round((widget.attr("x")-strategyPadding)/nodeTotalSpacingHorizontal);
                    if(currentRank != initRank){
                        reorderByRank(initRank, currentRank);
                        widgetData.rank = currentRank;
                        initRank = currentRank;
                    }
                    if(currentClassification != initClassification){
                        widgetData.node.classification = currentClassification;
                        initClassification = currentClassification;
                    }
                    renderNodeLinks(svg, nodeMidpointHorizontal);
                  })
                  .on("end", function() {
                    if (widgetData.node.classification < 0) widgetData.node.classification = 0;
                    if (widgetData.node.classification > 2) widgetData.node.classification = 2;
                    if (widgetData.rank < 0) widgetData.rank = 0;
                    if (widgetData.rank > nodeStrategySet.length-1) widgetData.rank = nodeStrategySet.length-1;
                    widget.select("rect").attr("fill", color).attr("y", 0).attr("x",0)
                      .attr("width", `${nodeWidth}`).attr("height", `${nodeHeight}`).attr("filter", "");
                    widget.attr("y",(d,i)=>`${d.rank*nodeTotalSpacingVertical+strategyPadding+strategyInfoHeight}`)
                        .attr("x", (d,i) => `${nodeTotalSpacingHorizontal*d.node.classification+strategyPadding}`);
                    dragDropIcons.style("cursor","grab");
                    updateJson();
                    renderNodeLinks(svg, nodeMidpointHorizontal);
                    widget = undefined;
                  });

                drags(nodes);
              }
              makeDragDropNode();

          }

          $.ajaxSetup({
              beforeSend: function(xhr, settings) {
                  if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                      xhr.setRequestHeader("X-CSRFToken", getCsrfToken());
                  }
              }
          });

          function csrfSafeMethod(method) {

              return /^(GET|HEAD|OPTIONS|TRACE)$/.test(method);
          }
          function getCsrfToken() {
              return document
                .getElementsByName("csrfmiddlewaretoken")[0]
                .getAttribute("value");
            }
          function updateJson(){
            let posting = $.post("{% url 'update-activity-json' %}", {json: JSON.stringify(activityJson)});
            posting.done(function(data) {
              console.info(data);
          });
        }

          function addNode(nodePk, strategyPk){
            let posting = $.post("{% url 'add-node' %}", {nodePk: nodePk, strategyPk: strategyPk, activityPk: '{{ object.pk|safe }}'});
            posting.done(function(data) {
              activityJson = JSON.parse(data);
              console.log(activityJson);
              renderActivity(activityJson.strategyactivity_set, svgParent);
            });
          }

          function addStrategy(strategyPk){
            let posting = $.post("{% url 'add-node' %}", {strategyPk: strategyPk, activityPk: '{{ object.pk|safe }}'});
            posting.done(function(data) {
              activityJson = JSON.parse(data);
              console.log(activityJson);
              renderActivity(activityJson.strategyactivity_set, svgParent);
            });
          }

            });
  </script>
</html>
