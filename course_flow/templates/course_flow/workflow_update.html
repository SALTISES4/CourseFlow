
{% extends "course_flow/base.html" %}
<!-- -->
{% load static compress i18n %} {% get_current_language as LANGUAGE_CODE %}
<!-- -->
{% load static i18n %}
<!-- -->
{% block title %}{% endblock %}
<!-- -->
{% block metadescription %} {% endblock %}
<!-- -->
{% block header %}{% endblock %}
<!-- -->
{% block body %}

<div id=container class="body-wrapper"></div>
<div id="node-form-container"></div>

{% endblock %}
<!-- -->
{% block foot %} {% endblock %}
<!-- -->
{% csrf_token %}
<!-- -->
{% block scripts %}

<script nonce="{{request.csp_nonce}}">
var selection_manager;
var initial_loading = true;
var items_to_load = {
    column:{{column_count}},
    strategy:{{strategy_count}},
    node:{{node_count}},
    nodelink:{{node_link_count}},
};
console.log(items_to_load);
$(document).on("component-loaded",(evt,objectType)=>{
    if(objectType&&items_to_load[objectType]){
        items_to_load[objectType]--;
        for(prop in items_to_load){
            if(items_to_load[prop]>0)return;
        }
        initial_loading=false;
        console.log("finished initial loading");
        $(document).triggerHandler("render-ports");
        $(document).triggerHandler("render-links");
    }
});
    
window.addEventListener("load", function(){
    selection_manager = new workflow.SelectionManager();
    
    
    let fetchThenRenderWorkflow = function(){
        $.getJSON('{% url "course_flow:workflow-detail" pk=object.pk %}',
            function(json){
                workflow.renderWorkflowView(json,$("#container").get()[0]);
            }
        );
    }
    
    fetchThenRenderWorkflow();
    
})


function updateValue(objectID,objectType,json,callBackFunction=()=>console.log("success")){
    $.post("{% url 'course_flow:update-value' %}", {
        objectID:JSON.stringify(objectID),
        objectType:JSON.stringify(objectType),
        data:JSON.stringify(json)
    }).done(function(data){
        if(data.action == "posted") callBackFunction(data);
        else console.log("Failed");
    });
}
    
    
function newColumn(workflowPk,column_type,callBackFunction=()=>console.log("success")){
    $.post("{% url 'course_flow:new-column' %}", {
        workflowPk:workflowPk,
        column_type:column_type
    }).done(function(data){
        if(data.action == "posted") callBackFunction(data);
        else console.log("Failed");
    });
}
    
    
function newNode(strategyPk,position=-1,column,callBackFunction=()=>console.log("success")){
    $.post("{% url 'course_flow:new-node' %}", {
        strategyPk:JSON.stringify(strategyPk),
        position:JSON.stringify(position),
        columnPk:JSON.stringify(column),        
    }).done(function(data){
        if(data.action == "posted") callBackFunction(data);
        else console.log("Failed");
    });
}
  
function newNodeLink(source_node,target_node,source_port,target_port,callBackFunction=()=>console.log("success")){
    $.post("{% url 'course_flow:new-node-link' %}", {
        nodePk:JSON.stringify(source_node),
        targetID:JSON.stringify(target_node),
        sourcePort:JSON.stringify(source_port),
        targetPort:JSON.stringify(target_port),
        
    }).done(function(data){
        if(data.action == "posted") callBackFunction(data);
        else console.log("Failed");
    });
}  

//Causes the specified object to delete itself
function deleteSelf(objectID,objectType,callBackFunction=()=>console.log("success")){
    //Temporary confirmation; add better comfirmation dialogue later
    console.log(objectID);
    console.log(objectType);
    
    if(window.confirm("Are you sure you want to delete this "+objectType+"?")){
        $.post("{% url 'course_flow:delete-self' %}", {
            objectID:JSON.stringify(objectID),
            objectType:JSON.stringify(objectType)
        }).done(function(data){
            if(data.action == "posted") callBackFunction(data);
            else console.log("Failed");
        });
    }
}

//Causes the specified object to insert a sibling after itself
function insertSibling(objectID,objectType,parentID,callBackFunction=()=>console.log("success")){
    
    $.post("{% url 'course_flow:insert-sibling' %}", {
        objectID:JSON.stringify(objectID),
        objectType:JSON.stringify(objectType),
        parentID:JSON.stringify(parentID)
    }).done(function(data){
        if(data.action == "posted") callBackFunction(data);
        else console.log("Failed");
    });
}
    
//Called when an object in a list is reordered
function insertedAt(objectID,objectType,parentID,newPosition,newParentID,newColumnID,callBackFunction=()=>console.log("success")){
    
    
    $.post("{% url 'course_flow:inserted-at' %}", {
        objectID:JSON.stringify(objectID),
        objectType:JSON.stringify(objectType),
        parentID:JSON.stringify(parentID),
        newPosition:JSON.stringify(newPosition),
        newParentID:JSON.stringify(newParentID),
        newColumnID:JSON.stringify(newColumnID),
    }).done(function(data){
        if(data.action == "posted") callBackFunction(data);
        else console.log("Failed");
    });
}






</script>

{% endblock %}